<!-- A√ëADIR REQUIRED -->

{% extends 'base.html' %} {% load static %} {% block head %}
<link rel="stylesheet" href="{% static 'styles/form-optimized.css' %}?v=1" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />


<title>Obras P√∫blicas</title>
{% endblock %} {% block body %} {% include 'nav.html' %}
<form method="post">
  {% csrf_token %}
  <div class="main">
    <div class="titulo">
      <h1><b>Datos del interesado</b></h1>
    </div>
    <div class="left">
      <div class="form">
        <label for="nombre" class="text">Nombre:</label>
        <input
          type="text"
          class="input"
          id="nombre"
          name="nombre"
          placeholder="Nombre"
          required
          title="Ingrese un nombre"
          oninvalid="this.setCustomValidity('Ingrese un nombre')"
            oninput="this.setCustomValidity('')"
        />

        <label for="pApe" class="text">Apellido paterno:</label>
        <input
          type="text"
          id="pApe"
          class="input"
          name="pApe"
          placeholder="Apellido paterno"
          required
          oninvalid="this.setCustomValidity('Ingrese su apellido paterno')"
            oninput="this.setCustomValidity('')"
        />

        <label for="mApe" class="text">Apellido materno:</label>
        <input
          type="text"
          id="mApe"
          class="input"
          name="mApe"
          placeholder="Apellido materno"
          required
          oninvalid="this.setCustomValidity('Ingrese su apellido materno')"
            oninput="this.setCustomValidity('')"
        />

        <label for="bDay" class="text">Fecha de nacimiento:</label>
        <input
          id="bDay"
          name="bDay"
          type="text"
          placeholder="Fecha de nacimiento"
          required
          oninvalid="this.setCustomValidity('Ingrese su fecha de nacimiento')"
            oninput="this.setCustomValidity('')"
        />



        <label for="asunto" class="text">Asunto:</label>
        <select class="select" id="asunto" name="asunto" required oninvalid="this.setCustomValidity('Ingrese un asunto')" oninput="this.setCustomValidity('')">
          <option value="">Seleccione una opci√≥n</option>
          <option value="DOP00001">Arreglo de calles de terracer√≠a</option>
          <option value="DOP00002">Bacheo de calles</option>
          <option value="DOP00003">Limpieza de arroyos al sur de la ciudad
          </option>
          <option value="DOP00004">Limpieza o mantenimiento de rejillas pluviales
          </option>
          <option value="DOP00005">Pago de costo de participaci√≥n en licitaciones de obra p√∫blica
          </option>
          <option value="DOP00006">Rehabilitaci√≥n de calles</option>
          <option value="DOP00007">Retiro de escombro y material de arrastre
          </option>
          <option value="DOP00008">Solicitud de material caliche/Fresado (especificar)</option>
          <option value="DOP00009">Solicitud de pavimentaci√≥n de calles</option>
          <option value="DOP00010">Solicitud de reductores de velocidad</option>
          <option value="DOP00011">Solicitud de pintura para se√±alamientos viales</option>
          <option value="DOP00012">Arreglo de derrumbe de bardas</option>
          <option value="DOP00013">Tapiado</option>
        </select>

         <div class="field">
          <fieldset>
            <legend>¬øPertenece a alguna etnia?</legend>
            <label for="ets">
            <input type="radio" id="ets" class="radio" name="et" onclick="habilitar(true)">
              S√≠</label>
            <label for="etn">
            <input type="radio" id="etn" class="radio" name="et" onclick="habilitar(false)">
              No</label><br>
            <label for="etnia" class="text">Etnia:</label>
            <input type="text" id="etnia" name="etnia" class="input" placeholder="Etnia" disabled>
          </fieldset>
        </div>
      </div>
    </div>
    <div class="right">
      <div class="form">
        <label for="tel" class="text">Tel√©fono:</label>
        <input
          type="text"
          id="tel"
          maxlength="10"
          class="input"
          name="tel"
          placeholder="Tel√©fono"
          pattern="[0-9]{10}"
          title="El tel√©fono debe tener 10 d√≠gitos num√©ricos."
          required
          oninvalid="this.setCustomValidity('Ingrese un n√∫mero de tel√©fono')"
          oninput="this.setCustomValidity('')"
        />

        <label for="curp" class="text">CURP:</label>
        <input
          type="text"
          id="curp"
          maxlength="18"
          class="input"
          name="curp"
          placeholder="CURP"
          required
          oninvalid="this.setCustomValidity('Ingrese su CURP')"
          oninput="this.setCustomValidity('')"
        />

        <label for="sexo" class="text">G√©nero:</label>
        <select class="select" id="sexo" name="sexo" required oninvalid="this.setCustomValidity('Ingrese su sexo')" oninput="this.setCustomValidity('')">
          <option value="">Seleccione un opci√≥n</option>
          <option value="hombre">Hombre</option>
          <option value="mujer">Mujer</option>
          <option value="otro">Otro</option>
        </select>



        <label for="dir" class="text" >Direcci√≥n:</label>
        <input
          type="text"
          id="dir"
          class="input"
          name="dir"
          placeholder="Direcci√≥n: calle, colonia, n√∫mero ex., C.P."
          value="{{dir}}"
          required
          oninvalid="this.setCustomValidity('Ingrese una direcci√≥n')"
          oninput="this.setCustomValidity('')"
        />
        <div class="plus">
          <button
                  type="button"
                  class="addbtn"
                  id="ubi"
                  onclick="openm()">
                  <span class="addicon">
                    <img src="{% static 'images/addw.png' %}" alt="add" class="add" />
                  </span>
            <span class="txt">A√±adir direcci√≥n</span>
          </button>
        </div>

         <div class="field">
          <fieldset>
            <legend>¬øTiene alguna discapacidad?</legend>
            <label for="discs">
            <input type="radio" id="discs" name="disc" class="radio" onclick="habilitarD(true)">
              S√≠</label>
            <label for="discn">
            <input type="radio" id="discn" name="disc" class="radio" onclick="habilitarD(false)">
              No</label><br>
            <label for="disc" class="text">Discapacidad:</label>
            <select name="discapacidad" id="disc" class="select" disabled>
              <option value="">Seleccione una opci√≥n</option>
              <option value="Persona con discapacidad motriz">Persona con discapacidad motriz</option>
              <option value="Persona con discapacidad auditiva">Persona con discapacidad auditiva</option>
              <option value="Persona con discapacidad visual">Persona con discapacidad visual</option>
              <option value="Persona con discapacidad intelectual">Persona con discapacidad intelectual</option>
              <option value="Persona con discapacidad psicosocial">Persona con discapacidad psicosocial</option>
            </select>
            <!--input type="text" name="discapacidad" id="disc" class="input" placeholder="Discapacidad" disabled-->
          </fieldset>
        </div>
      </div>
    </div>
     <div class="field">
          <fieldset>
            <legend>¬øPertenece a alg√∫n grupo vulnerable?</legend>
            <label for="vulnerabless">
            <input type="radio" id="vulnerabless" name="vul" class="radio" onclick="habilitarV(true)">
              S√≠</label>
            <label for="vulnerablesn">
            <input type="radio" id="vulnerablesn" name="vul" class="radio" onclick="habilitarV(false)">
              No</label><br>
            <label for="vulnerables" class="text">Grupo vulnerable:</label>
            <select name="vulnerables" id="vulnerables" class="select" disabled>
              <option value="">Seleccione una opci√≥n</option>
              <option value="Padre o madre soltero(a), divorciado(a) o viudo(a)">Padre o madre soltero(a), divorciado(a) o viudo(a)</option>
              <option value="Personas mayores de 60 a√±os">Personas mayores de 60 a√±os</option>
              <option value="Persona con discapacidad total permanente">Persona con discapacidad total permanente</option>
              <option value="Persona pensionadas o jubiladas">Persona pensionadas o jubiladas</option>
              <option value="Familiar de persona con discapacidad total o permanente">Familiar de persona con discapacidad total o permanente</option>
              <option value="V√≠ctimas indirectas del delito de feminicidio">V√≠ctimas indirectas del delito de feminicidio</option>
            </select>
            <!--input type="text" name="discapacidad" id="disc" class="input" placeholder="Discapacidad" disabled-->
          </fieldset>
        </div>
  </div>

  <div class="Ibottom">
    <div class="lBtn">
      <button type="button" class="back bbtn" id="back" data-url="{% url 'clear' %}">Regresar</button>
    </div>
    <div class="rBtn">
      <button type="submit" class="next nbtn" id="next">Siguiente</button>
    </div>
  </div>
</form>
<div class="modal hidden" id="modal">
    {% include 'modals/modal_map.html' %}
</div>
{% endblock %}

{% block footer %}

<script src="{% static 'sripts/btnScripts.js' %}"></script>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/esri-leaflet@3.0.8/dist/esri-leaflet.js"></script>

<script src="{% static 'sripts/LocalGisMap.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let localMap = null;

    // Funci√≥n global para seleccionar ubicaci√≥n desde el mapa
    window.selectMapLocation = function(address, lat, lng) {
        document.getElementById('dir').value = address;

        const inputModal = document.getElementById('dirr');
        if (inputModal) {
            inputModal.value = address;
        }

        console.log(`Direcci√≥n seleccionada: ${address} (${lat}, ${lng})`);

        // Mostrar confirmaci√≥n visual
        const confirmMsg = document.createElement('div');
        confirmMsg.innerHTML = `‚úÖ Direcci√≥n seleccionada: ${address}`;
        confirmMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4CAF50; color: white; padding: 10px; border-radius: 5px; z-index: 10000;';
        document.body.appendChild(confirmMsg);

        setTimeout(() => confirmMsg.remove(), 3000);
    };

    // Funci√≥n para b√∫squeda manual
    window.buscarDireccion = async function() {
        const inputModal = document.getElementById('dirr');
        const address = inputModal.value.trim();

        if (!address) {
            alert('Por favor ingresa una direcci√≥n para buscar');
            return;
        }

        if (address.length < 3) {
            alert('La direcci√≥n debe tener al menos 3 caracteres');
            return;
        }

        if (localMap) {
            const originalValue = inputModal.value;
            inputModal.value = 'Buscando...';
            inputModal.disabled = true;

            try {
                const result = await localMap.geocodeAddress(address);

                if (result && result.success) {
                    console.log('‚úÖ Direcci√≥n encontrada:', result.result);
                } else {
                    alert('No se pudo encontrar la direcci√≥n. Intenta con una descripci√≥n m√°s espec√≠fica.');
                    inputModal.value = originalValue;
                }
            } catch (error) {
                console.error('Error en b√∫squeda:', error);
                alert('Error al buscar la direcci√≥n. Intenta nuevamente.');
                inputModal.value = originalValue;
            } finally {
                inputModal.disabled = false;
                inputModal.focus();
            }
        } else {
            alert('El mapa no est√° listo. Espera un momento e intenta nuevamente.');
        }
    };

    // Funci√≥n para inicializar el mapa
    function initializeMap() {
        const mapHolder = document.querySelector('.mapholder');

        if (!localMap && mapHolder && typeof LocalGISMap !== 'undefined') {
            const mapDiv = document.createElement('div');
            mapDiv.id = 'map';
            mapDiv.style.cssText = 'width: 100%; height: 25rem; border: 2px solid #014277; background-color: lightgrey; cursor: crosshair;';

            // Agregar instrucciones
            const instructions = document.createElement('div');
            instructions.innerHTML = `
                <div style="background: #f0f8ff; padding: 8px; border-radius: 4px; margin-bottom: 10px; font-size: 12px;">
                    üí° <strong>C√≥mo buscar:</strong><br>
                    ‚Ä¢ Escribe en el campo de arriba para buscar una direcci√≥n<br>
                    ‚Ä¢ Haz clic en el mapa para seleccionar una ubicaci√≥n<br>
                    ‚Ä¢ Usa el bot√≥n "Seleccionar" para confirmar
                </div>
            `;

            mapHolder.innerHTML = '';
            mapHolder.appendChild(instructions);
            mapHolder.appendChild(mapDiv);

            setTimeout(() => {
                try {
                    localMap = new LocalGISMap('map', {
                        center: [28.6353, -106.0889],
                        zoom: 12
                    });
                    console.log('Mapa inicializado correctamente');
                } catch (error) {
                    console.error('Error creando LocalGISMap:', error);
                }
            }, 100);
        } else if (typeof LocalGISMap === 'undefined') {
            console.error('LocalGISMap no est√° definido. Verifica que LocalGisMap.js se haya cargado.');
        }
    }

    // Funci√≥n para abrir modal
    window.openm = function() {
        const modal = document.getElementById('modal');
        modal.classList.remove('hidden');
        modal.style.display = 'block';

        const inputModal = document.getElementById('dirr');
        if (inputModal) {
            inputModal.value = '';
            setTimeout(() => inputModal.focus(), 300);
        }

        setTimeout(initializeMap, 200);
    };

    // Funci√≥n para cerrar modal
    window.closem = function() {
        const modal = document.getElementById('modal');
        modal.classList.add('hidden');
        modal.style.display = 'none';
    };

    // Funci√≥n para enviar direcci√≥n
    window.enviar = function() {
        const direccionModal = document.getElementById('dirr').value.trim();
        if (direccionModal) {
            document.getElementById('dir').value = direccionModal;

            // Mostrar confirmaci√≥n
            const confirmMsg = document.createElement('div');
            confirmMsg.innerHTML = `‚úÖ Direcci√≥n guardada: ${direccionModal}`;
            confirmMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4CAF50; color: white; padding: 10px; border-radius: 5px; z-index: 10000;';
            document.body.appendChild(confirmMsg);

            setTimeout(() => confirmMsg.remove(), 3000);
        }
        closem();
    };

    // Cerrar modal al hacer clic fuera
    window.onclick = function(event) {
        const modal = document.getElementById('modal');
        if (event.target === modal) {
            closem();
        }
    };
});

// Funci√≥n para habilitar campos condicionales
function habilitar(estado) {
    document.getElementById("etnia").disabled = !estado;
}

function habilitarD(estado) {
    document.getElementById("disc").disabled = !estado;
}

function habilitarV(estado) {
    document.getElementById("vulnerables").disabled = !estado;
}
</script>

<!-- Flatpickr -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
<script src="{% static 'sripts/modals.js' %}"></script>

<script>
flatpickr("#bDay", {
    dateFormat: "Y-m-d",
    locale: "es",
    altInput: true,
    altFormat: "F j, Y",
});
</script>

{% endblock %}