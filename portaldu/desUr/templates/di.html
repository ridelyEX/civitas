<!-- A√ëADIR REQUIRED -->

{% extends 'base.html' %} {% load static %} {% block head %}
<link rel="stylesheet" href="{% static 'styles/form-optimized.css' %}?v=1" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
{% load django_bootstrap5 %}
{% bootstrap_css %}
{% bootstrap_javascript %}


<title>Obras P√∫blicas</title>
{% endblock %} {% block body %} {% include 'nav.html' %}
<form method="post">
  {% csrf_token %}
  <div class="main">
    <div class="titulo">
      <h1><b>DATOS DEL INTERESADO</b></h1>
    </div>
    <div class="left">
      <div class="form">
        <label for="nombre" class="text">NOMBRE:</label>
        <input
          type="text"
          class="input"
          id="nombre"
          name="nombre"
          placeholder="Nombre"
          required
          title="Ingrese un nombre"
          oninvalid="this.setCustomValidity('Ingrese un nombre')"
            oninput="this.setCustomValidity('')"
        />

        <label for="pApe" class="text">APELLIDO PATERNO:</label>
        <input
          type="text"
          id="pApe"
          class="input"
          name="pApe"
          placeholder="Apellido paterno"
          required
          oninvalid="this.setCustomValidity('Ingrese su apellido paterno')"
            oninput="this.setCustomValidity('')"
        />

        <label for="mApe" class="text">APELLIDO MATERNO:</label>
        <input
          type="text"
          id="mApe"
          class="input"
          name="mApe"
          placeholder="Apellido materno"
          required
          oninvalid="this.setCustomValidity('Ingrese su apellido materno')"
            oninput="this.setCustomValidity('')"
        />

        <label for="bDay" class="text">FECHA DE NACIMIENTO:</label>
        <input
          id="bDay"
          name="bDay"
          type="text"
          placeholder="Fecha de nacimiento"
          required
          oninvalid="this.setCustomValidity('Ingrese su fecha de nacimiento')"
            oninput="this.setCustomValidity('')"
        />



        <label for="asunto" class="text">ASUNTO:</label>
        <select class="select" id="asunto" name="asunto" required oninvalid="this.setCustomValidity('Ingrese un asunto')" oninput="this.setCustomValidity('')">
          <option value="">Seleccione una opci√≥n</option>
          <option value="DOP00001">Arreglo de calles de terracer√≠a</option>
          <option value="DOP00002">Bacheo de calles</option>
          <option value="DOP00003">Limpieza de arroyos al sur de la ciudad
          </option>
          <option value="DOP00004">Limpieza o mantenimiento de rejillas pluviales
          </option>
          <option value="DOP00005">Pago de costo de participaci√≥n en licitaciones de obra p√∫blica
          </option>
          <option value="DOP00006">Rehabilitaci√≥n de calles</option>
          <option value="DOP00007">Retiro de escombro y material de arrastre
          </option>
          <option value="DOP00008">Solicitud de material caliche/Fresado (especificar)</option>
          <option value="DOP00009">Solicitud de pavimentaci√≥n de calles concreto hidr√°ulico</option>
          <option value="DOP00010">Solicitud de reductores de velocidad</option>
          <option value="DOP00011">Solicitud de pintura para se√±alamientos viales</option>
          <option value="DOP00012">Arreglo de derrumbe de bardas</option>
          <option value="DOP00013">Tapiado</option>
        </select>

         <div class="field">
          <fieldset>
            <legend>¬øPERTENECE A ALGUNA ETNIA?</legend>
            <label for="ets">
            <input type="radio" id="ets" class="radio" name="et" onclick="habilitar(true)">
              S√≠</label>
            <label for="etn">
            <input type="radio" id="etn" class="radio" name="et" onclick="habilitar(false)">
              No</label><br>
            <label for="etnia" class="text">ETNIA:</label>
            <input type="text" id="etnia" name="etnia" class="input" placeholder="Etnia" disabled>
          </fieldset>
        </div>
      </div>
    </div>
    <div class="right">
      <div class="form">
        <label for="tel" class="text">TEL√âFONO:</label>
        <input
          type="text"
          id="tel"
          maxlength="10"
          class="input"
          name="tel"
          placeholder="Tel√©fono"
          pattern="[0-9]{10}"
          title="El tel√©fono debe tener 10 d√≠gitos num√©ricos."
          required
          oninvalid="this.setCustomValidity('Ingrese un n√∫mero de tel√©fono')"
          oninput="this.setCustomValidity('')"
        />

        <label for="curp" class="text">CURP:</label>
        <input
          type="text"
          id="curp"
          maxlength="18"
          class="input"
          name="curp"
          placeholder="CURP"
          required
          oninvalid="this.setCustomValidity('Ingrese su CURP')"
          oninput="this.setCustomValidity('')"
        />

        <label for="sexo" class="text">G√âNERO:</label>
        <select class="select" id="sexo" name="sexo" required oninvalid="this.setCustomValidity('Ingrese su sexo')" oninput="this.setCustomValidity('')">
          <option value="">Seleccione un opci√≥n</option>
          <option value="hombre">Hombre</option>
          <option value="mujer">Mujer</option>
          <option value="otro">Otro</option>
        </select>



        <label for="dir" class="text" >DIRECCI√ìN:</label>
        <input
          type="text"
          id="dir"
          class="input"
          name="dir"
          placeholder="Direcci√≥n: calle, colonia, n√∫mero ex., C.P."
          value="{{dir}}"
          required
          oninvalid="this.setCustomValidity('Ingrese una direcci√≥n')"
          oninput="this.setCustomValidity('')"
        />
        <div class="plus">
          <button
                  type="button"
                  class="addbtn"
                  id="ubi"
                  data-bs-toggle="modal"
                  data-bs-target="#buscarDireccionModal"
          >
                  <!--onclick="openm()"-->
                  <span class="addicon">
                    <img src="{% static 'images/addw.png' %}" alt="add" class="add" />
                  </span>
            <span class="txt">A√±adir direcci√≥n</span>
          </button>
        </div>

         <div class="field">
          <fieldset>
            <legend>¬øTIENE ALGUNA DISCAPACIDAD?</legend>
            <label for="discs">
            <input type="radio" id="discs" name="disc" class="radio" onclick="habilitarD(true)">
              S√≠</label>
            <label for="discn">
            <input type="radio" id="discn" name="disc" class="radio" onclick="habilitarD(false)">
              No</label><br>
            <label for="disc" class="text">DISCAPACIDAD:</label>
            <select name="discapacidad" id="disc" class="select" disabled>
              <option value="">Seleccione una opci√≥n</option>
              <option value="Persona con discapacidad motriz">Persona con discapacidad motriz</option>
              <option value="Persona con discapacidad auditiva">Persona con discapacidad auditiva</option>
              <option value="Persona con discapacidad visual">Persona con discapacidad visual</option>
              <option value="Persona con discapacidad intelectual">Persona con discapacidad intelectual</option>
              <option value="Persona con discapacidad psicosocial">Persona con discapacidad psicosocial</option>
            </select>
            <!--input type="text" name="discapacidad" id="disc" class="input" placeholder="Discapacidad" disabled-->
          </fieldset>
        </div>
      </div>
    </div>
     <div class="field">
          <fieldset>
            <legend>¬øPERTENECE A ALG√öN GRUPO VULNERABLE?</legend>
            <label for="vulnerabless">
            <input type="radio" id="vulnerabless" name="vul" class="radio" onclick="habilitarV(true)">
              S√≠</label>
            <label for="vulnerablesn">
            <input type="radio" id="vulnerablesn" name="vul" class="radio" onclick="habilitarV(false)">
              No</label><br>
            <label for="vulnerables" class="text">GRUPO VULNERABLE:</label>
            <select name="vulnerables" id="vulnerables" class="select" disabled>
              <option value="">Seleccione una opci√≥n</option>
              <option value="Padre o madre soltero(a), divorciado(a) o viudo(a)">Padre o madre soltero(a), divorciado(a) o viudo(a)</option>
              <option value="Personas mayores de 60 a√±os">Personas mayores de 60 a√±os</option>
              <option value="Persona con discapacidad total permanente">Persona con discapacidad total permanente</option>
              <option value="Persona pensionadas o jubiladas">Personas pensionadas o jubiladas</option>
              <option value="Familiar de persona con discapacidad total o permanente">Familiar de persona con discapacidad total o permanente</option>
              <option value="V√≠ctimas indirectas del delito de feminicidio">V√≠ctimas indirectas del delito de feminicidio</option>
            </select>
            <!--input type="text" name="discapacidad" id="disc" class="input" placeholder="Discapacidad" disabled-->
          </fieldset>
        </div>
  </div>

  <div class="Ibottom">
    <div class="lBtn">
      <button type="button" class="back bbtn" id="back" data-url="{% url 'clear' %}">Regresar</button>
    </div>
    <div class="rBtn">
      <button type="submit" class="next nbtn" id="next">Siguiente</button>
    </div>
  </div>
</form>
<div class="modal hidden" id="modal">
    {% include 'modals/modal_map.html' %}
</div>

{% include 'modals/buscar_direccion.html' %}
{% endblock %}

{% block footer %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar modal manualmente
    const modalElement = document.getElementById('buscarDireccionModal');
    if (modalElement) {
        const modal = new bootstrap.Modal(modalElement);

        // Evento para el bot√≥n que abre el modal
        document.querySelectorAll('[data-bs-target="#buscarDireccionModal"]').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                modal.show();
            });
        });
    }
});


</script>

<script src="{% static 'sripts/btnScripts.js' %}"></script>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/esri-leaflet@3.0.8/dist/esri-leaflet.js"></script>

<script src="{% static 'sripts/LocalGisMap.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let localMap = null;

    // Funci√≥n global para seleccionar ubicaci√≥n desde el mapa
    window.selectMapLocation = function(address, lat, lng, components = {}) {
        // Actualizar input principal del formulario
        const mainInput = document.getElementById('dir');
        if (mainInput) {
            mainInput.value = address;
        }

        // Actualizar input del modal
        const modalInput = document.getElementById('dirr');
        if (modalInput) {
            modalInput.value = address;
        }

        // Actualizar inputs espec√≠ficos con componentes
        if (components && typeof components === 'object') {
            const fieldMappings = {
                'calle': components.calle || '',
                'numero': components.numero || '',
                'colonia': components.colonia || '',
                'codigo_postal': components.codigo_postal || '',
                'ciudad': components.ciudad || 'Chihuahua',
                'estado': components.estado || 'Chihuahua'
            };

            for (const [fieldName, value] of Object.entries(fieldMappings)) {
                const field = document.getElementById(fieldName);
                if (field && value) {
                    field.value = value;
                    console.log(`Campo ${fieldName} actualizado con: ${value}`);
                }
            }
        }

        // Mostrar confirmaci√≥n con detalles
        const confirmMsg = document.createElement('div');
        let detailsHtml = '';

        if (components && typeof components === 'object') {
            const details = [];
            if (components.calle) details.push(`Calle: ${components.calle}`);
            if (components.numero) details.push(`N√∫m: ${components.numero}`);
            if (components.colonia) details.push(`Col: ${components.colonia}`);
            if (components.codigo_postal) details.push(`CP: ${components.codigo_postal}`);

            if (details.length > 0) {
                detailsHtml = `<small style="display:block; margin-top:4px; opacity:0.9;">${details.join(' | ')}</small>`;
            }
        }

        confirmMsg.innerHTML = `
            ‚úÖ <strong>Direcci√≥n seleccionada</strong><br>
            ${address}
            ${detailsHtml}
        `;
        confirmMsg.style.cssText = `
            position: fixed; top: 20px; right: 20px;
            background: #4CAF50; color: white;
            padding: 12px 16px; border-radius: 6px;
            z-index: 10000; max-width: 300px;
            font-size: 13px; box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        `;

        document.body.appendChild(confirmMsg);
        setTimeout(() => confirmMsg.remove(), 4000);

        console.log('Direcci√≥n seleccionada:', {
            address, lat, lng, components
        });
    };

    // Funci√≥n global SEPARADA para manejar la selecci√≥n desde popup
    window.selectMapLocationFromPopup = function(address, lat, lng, componentsStr) {
        try {
            console.log('Datos recibidos en popup:', { address, lat, lng, componentsStr });

            // Parsear componentes
            let components = {};
            if (componentsStr && componentsStr !== '{}') {
                // Decodificar caracteres HTML
                const decodedStr = componentsStr.replace(/&#39;/g, "'").replace(/&quot;/g, '"');
                components = JSON.parse(decodedStr);
                console.log('Componentes parseados:', components);
            }

            // Llamar a la funci√≥n principal
            window.selectMapLocation(address, lat, lng, components);

        } catch (error) {
            console.error('Error procesando selecci√≥n desde popup:', error);
            console.log('Usando fallback sin componentes');
            // Fallback sin componentes
            window.selectMapLocation(address, lat, lng, {});
        }
    };

    // Funci√≥n para b√∫squeda manual
    window.buscarDireccion = async function() {
        const inputModal = document.getElementById('dirr');
        let address = inputModal.value.trim();

        if (!address) {
            alert('Por favor ingresa una direcci√≥n para buscar');
            return;
        }

        address = address.replace(/\s+/g, ' ');
        address = address.replace(/[^\w\s√°√©√≠√≥√∫√±√º#.,]/gi, ' ');

        if (address.length < 3) {
            alert('La b√∫squeda debe tener al menos 3 caracteres');
            return;
        }

        if (localMap) {
            const originalValue = inputModal.value;
            const originalPlaceholder = inputModal.placeholder;

            inputModal.value = 'Buscando direcci√≥n...';
            inputModal.disabled = true;

            try {
                console.log(`üîç Buscando: "${address}"`);

                const result = await localMap.geocodeAddress(address);

                if (result && result.success) {
                    console.log('‚úÖ B√∫squeda exitosa:', result.result);
                    // El popup ya se encarga de mostrar el resultado
                } else {
                    console.log('‚ùå No se encontr√≥:', result.error);
                    alert(`No se encontr√≥ la direcci√≥n: ${address}\n\nIntenta con:\n‚Ä¢ Formato: "Calle Nombre #123"\n‚Ä¢ Agregar colonia o c√≥digo postal`);
                }

                inputModal.value = originalValue;
                inputModal.disabled = false;

            } catch (error) {
                console.error('Error en b√∫squeda:', error);

                const errorMsg = document.createElement('div');
                errorMsg.innerHTML = `‚ùå <strong>Error de conexi√≥n</strong><br><small>Verifica tu internet e intenta nuevamente</small>`;
                errorMsg.style.cssText = `
                    position: fixed; top: 20px; right: 20px;
                    background: #f44336; color: white;
                    padding: 12px; border-radius: 6px;
                    z-index: 10000; max-width: 300px;
                    font-size: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                `;
                document.body.appendChild(errorMsg);
                setTimeout(() => errorMsg.remove(), 4000);

                inputModal.value = originalValue;
                inputModal.disabled = false;
            }

            inputModal.placeholder = originalPlaceholder;
        }
    };

    // Funci√≥n para inicializar el mapa
    function initializeMap() {
        const mapHolder = document.querySelector('.mapholder');

        if (!localMap && mapHolder && typeof LocalGISMap !== 'undefined') {
            const mapDiv = document.createElement('div');
            mapDiv.id = 'map';
            mapDiv.style.cssText = 'width: 100%; height: 25rem; border: 2px solid #014277; background-color: lightgrey; cursor: crosshair;';

            const instructions = document.createElement('div');
            instructions.innerHTML = `
                <div style="
                    background: #e3f2fd; border: 1px solid #2196f3; padding: 8px;
                    border-radius: 4px; margin-bottom: 8px; font-size: 12px;
                ">
                    <strong>üí° Instrucciones:</strong><br>
                    ‚Ä¢ <strong>Buscar:</strong> Escribe una direcci√≥n y presiona "Buscar"<br>
                    ‚Ä¢ <strong>Hacer clic:</strong> Haz clic en cualquier punto del mapa<br>
                    ‚Ä¢ <strong>Seleccionar:</strong> Usa el bot√≥n "Seleccionar" en el popup
                </div>
            `;

            mapHolder.innerHTML = '';
            mapHolder.appendChild(instructions);
            mapHolder.appendChild(mapDiv);

            setTimeout(() => {
                try {
                    localMap = new LocalGISMap('map', {
                        center: [28.6353, -106.0889],
                        zoom: 12
                    });
                    console.log('‚úÖ Mapa inicializado correctamente');
                } catch (error) {
                    console.error('‚ùå Error inicializando mapa:', error);
                    mapDiv.innerHTML = `<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">Error cargando el mapa</div>`;
                }
            }, 100);
        } else if (typeof LocalGISMap === 'undefined') {
            console.error('LocalGISMap no est√° definido. Verifica que LocalGisMap.js se haya cargado.');
        }
    }

    // Resto de funciones para modal...
    window.openm = function() {
        const modal = document.getElementById('modal');
        modal.classList.remove('hidden');
        modal.style.display = 'block';

        const inputModal = document.getElementById('dirr');
        if (inputModal) {
            inputModal.value = '';
            setTimeout(() => inputModal.focus(), 300);
        }

        setTimeout(initializeMap, 200);
    };

    window.closem = function() {
        const modal = document.getElementById('modal');
        modal.classList.add('hidden');
        modal.style.display = 'none';
    };

    window.enviar = function() {
        const direccionModal = document.getElementById('dirr').value.trim();
        if (direccionModal) {
            document.getElementById('dir').value = direccionModal;

            const confirmMsg = document.createElement('div');
            confirmMsg.innerHTML = `‚úÖ Direcci√≥n guardada: ${direccionModal}`;
            confirmMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4CAF50; color: white; padding: 10px; border-radius: 5px; z-index: 10000;';
            document.body.appendChild(confirmMsg);

            setTimeout(() => confirmMsg.remove(), 3000);
        }
        closem();
    };

    window.onclick = function(event) {
        const modal = document.getElementById('modal');
        if (event.target === modal) {
            closem();
        }
    };
});

// Funci√≥n para habilitar campos condicionales
function habilitar(estado) {
    document.getElementById("etnia").disabled = !estado;
}

function habilitarD(estado) {
    document.getElementById("disc").disabled = !estado;
}

function habilitarV(estado) {
    document.getElementById("vulnerables").disabled = !estado;
}
    document.addEventListener('DOMContentLoaded', function() {
        const modalEl = document.getElementById('buscarDireccionModal');
        if (modalEl && typeof bootstrap !== 'undefined') {
            console.log('Modal inicializado correctamente');
        }
    });
</script>

<!-- Flatpickr -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
<script src="{% static 'sripts/modals.js' %}"></script>

<script>
flatpickr("#bDay", {
    dateFormat: "Y-m-d",
    locale: "es",
    altInput: true,
    altFormat: "F j, Y",
});
</script>

{% endblock %}