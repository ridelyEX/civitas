{% extends 'auth/auth_base.html' %}{% load static %}

{% block head %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'styles/auth-styles.css' %}?v=1">
{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-card">
        <div class="auth-card-header">
            <h3>Iniciar Sesi贸n - DesUr</h3>
        </div>
        <div class="auth-card-body">
            {% if messages %}
                {% for message in messages %}
                    <div class="auth-alert auth-alert-error">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}

            <form method="post">
                {% csrf_token %}
                <div class="auth-form-group">
                    <label for="id_usuario" class="auth-form-label">Usuario:</label>
                    {{ form.usuario }}
                    {% if form.usuario.errors %}
                        <div class="auth-error">{{ form.usuario.errors }}</div>
                    {% endif %}
                </div>
                <div class="auth-form-group">
                    <label for="id_contrasena" class="auth-form-label">Contrase帽a:</label>
                    {{ form.contrasena }}
                    {% if form.contrasena.errors %}
                        <div class="auth-error">{{ form.contrasena.errors }}</div>
                    {% endif %}
                </div>
                <div class="auth-form-group">
                    <button type="submit" class="auth-btn-primary">Iniciar Sesi贸n</button>
                    <a href="{% url 'desur_users' %}" class="auth-btn-secondary">Crear Cuenta</a>
                </div>
            </form>
                     <button id="install-button" style="display: none;" class="btn btn-primary">
                          Instalar App
                     </button>
                    <button onclick="testInstall()" class="btn btn-info"> Test PWA</button>
        </div>
    </div>
</div>
{% endblock %}

{% block footer %}
<div class="auth-footer"></div>

<script>
   // Registrar Service Worker
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register("{% static 'sripts/sw.js' %}")
        .then(registration => console.log('SW registrado'))
        .catch(error => console.log('Error SW:', error));
}

// PWA Install
let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    document.getElementById('install-button').style.display = 'block';
});

document.getElementById('install-button').addEventListener('click', () => {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
                console.log('Usuario instal贸 la PWA');
            }
            deferredPrompt = null;
        });
    }
});

function testInstall() {
    if ('serviceWorker' in navigator) {
        console.log('Service Worker soportado');
    } else {
        console.log('Service Worker NO soportado');
    }

    const installButton = document.getElementById('install-button');
    installButton.style.display = 'block';
    console.log('Bot贸n de instalaci贸n mostrado manualmente');
}
</script>
{% endblock %}
