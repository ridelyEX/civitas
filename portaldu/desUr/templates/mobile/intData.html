<!-- templates/mobile/intData.html -->
{% extends 'mobile/base.html' %}

{% block title %}Datos del Ciudadano - Civitas Mobile{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">üìã Datos del Ciudadano</h5>
            </div>
            <div class="card-body">
                <!-- Formulario optimizado para m√≥vil -->
                <form id="mobile-intdata-form" novalidate>
                    {% csrf_token %}

                    <!-- Datos personales -->
                    <div class="mb-3">
                        <label for="nombre" class="form-label">Nombre(s) *</label>
                        <input type="text" class="form-control form-control-lg" id="nombre" name="nombre"
                               value="{{ datos.nombre|default:'' }}" required>
                    </div>

                    <div class="row">
                        <div class="col-6 mb-3">
                            <label for="pApe" class="form-label">Apellido Paterno *</label>
                            <input type="text" class="form-control" id="pApe" name="pApe"
                                   value="{{ datos.pApe|default:'' }}" required>
                        </div>
                        <div class="col-6 mb-3">
                            <label for="mApe" class="form-label">Apellido Materno *</label>
                            <input type="text" class="form-control" id="mApe" name="mApe"
                                   value="{{ datos.mApe|default:'' }}" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-7 mb-3">
                            <label for="bDay" class="form-label">Fecha de Nacimiento *</label>
                            <input type="date" class="form-control" id="bDay" name="bDay"
                                   value="{{ datos.bDay|default:'' }}" required>
                        </div>
                        <div class="col-5 mb-3">
                            <label for="sexo" class="form-label">Sexo *</label>
                            <select class="form-select" id="sexo" name="sexo" required>
                                <option value="">Seleccionar</option>
                                <option value="H" {% if datos.sexo == 'H' %}selected{% endif %}>Hombre</option>
                                <option value="M" {% if datos.sexo == 'M' %}selected{% endif %}>Mujer</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="tel" class="form-label">Tel√©fono *</label>
                        <input type="tel" class="form-control" id="tel" name="tel"
                               value="{{ datos.tel|default:'' }}" placeholder="10 d√≠gitos" required>
                    </div>

                    <div class="mb-3">
                        <label for="curp" class="form-label">CURP *</label>
                        <input type="text" class="form-control text-uppercase" id="curp" name="curp"
                               value="{{ datos.curp|default:'' }}" maxlength="18"
                               placeholder="CURP de 18 caracteres" required>
                    </div>

                    <!-- Direcci√≥n con geolocalizaci√≥n -->
                    <div class="mb-3">
                        <label for="dir" class="form-label">Direcci√≥n *</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="dir" name="dir"
                                   value="{{ datos.dir|default:dir }}" required>
                            <button type="button" class="btn btn-outline-primary" id="get-location">
                                üìç GPS
                            </button>
                        </div>
                        <small class="form-text text-muted">
                            Usa el bot√≥n GPS para obtener la ubicaci√≥n autom√°ticamente
                        </small>
                    </div>

                    <!-- Asunto -->
                    <div class="mb-3">
                        <label for="asunto" class="form-label">Tipo de Tr√°mite *</label>
                        <select class="form-select" id="asunto" name="asunto" required>
                            <option value="">Seleccionar tr√°mite...</option>
                            <option value="DOP00001">Constancia de Residencia</option>
                            <option value="DOP00002">Carta de No Antecedentes Penales</option>
                            <option value="DOP00003">Constancia de Ingresos</option>
                            <option value="DOP00004">Carta de Recomendaci√≥n</option>
                            <option value="DOP00005">Licencia de Funcionamiento</option>
                            <option value="DOP00006">Permiso Temporal</option>
                        </select>
                    </div>

                    <!-- Datos adicionales -->
                    <div class="accordion mb-3" id="additional-data">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#collapse-additional">
                                    Datos Adicionales (Opcional)
                                </button>
                            </h2>
                            <div id="collapse-additional" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <div class="mb-3">
                                        <label for="etnia" class="form-label">Pertenencia √âtnica</label>
                                        <select class="form-select" id="etnia" name="etnia">
                                            <option value="No pertenece a una etnia">No pertenece a una etnia</option>
                                            <option value="Ind√≠gena">Ind√≠gena</option>
                                            <option value="Afromexicano">Afromexicano</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label for="discapacidad" class="form-label">Discapacidad</label>
                                        <select class="form-select" id="discapacidad" name="discapacidad">
                                            <option value="sin discapacidad">Sin discapacidad</option>
                                            <option value="motriz">Motriz</option>
                                            <option value="visual">Visual</option>
                                            <option value="auditiva">Auditiva</option>
                                            <option value="intelectual">Intelectual</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label for="vulnerables" class="form-label">Grupo Vulnerable</label>
                                        <select class="form-select" id="vulnerables" name="vulnerables">
                                            <option value="No pertenece a un grupo vulnerable">No pertenece</option>
                                            <option value="Adulto mayor">Adulto mayor</option>
                                            <option value="Mujer embarazada">Mujer embarazada</option>
                                            <option value="Menor de edad">Menor de edad</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botones de acci√≥n -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
                            <span id="submit-text">üíæ Guardar Datos</span>
                            <span id="submit-spinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span>
                        </button>

                        <button type="button" class="btn btn-outline-secondary" onclick="history.back()">
                            ‚Üê Regresar
                        </button>
                    </div>
                </form>

                <!-- Mostrar errores si existen -->
                {% if errors %}
                <div class="alert alert-danger mt-3">
                    <strong>‚ö†Ô∏è Errores encontrados:</strong>
                    <ul class="mb-0 mt-2">
                        {% for error in errors %}
                        <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmaci√≥n offline -->
<div class="modal fade" id="offline-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üì± Guardado Offline</h5>
            </div>
            <div class="modal-body">
                <p>Los datos se han guardado localmente y se sincronizar√°n autom√°ticamente cuando recupere la conexi√≥n a internet.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                    Entendido
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('mobile-intdata-form');
    const submitBtn = document.getElementById('submit-btn');
    const submitText = document.getElementById('submit-text');
    const submitSpinner = document.getElementById('submit-spinner');

    // Geolocalizaci√≥n
    document.getElementById('get-location').addEventListener('click', function() {
        if (navigator.geolocation) {
            this.innerHTML = '‚è≥ Obteniendo...';
            this.disabled = true;

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    try {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;

                        // Usar API de geocodificaci√≥n inversa
                        const response = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key={{ google_key }}`);
                        const data = await response.json();

                        if (data.results && data.results[0]) {
                            document.getElementById('dir').value = data.results[0].formatted_address;
                        } else {
                            document.getElementById('dir').value = `Lat: ${lat}, Lng: ${lng}`;
                        }
                    } catch (error) {
                        console.error('Error obteniendo direcci√≥n:', error);
                        document.getElementById('dir').value = `Lat: ${position.coords.latitude}, Lng: ${position.coords.longitude}`;
                    }

                    this.innerHTML = 'üìç GPS';
                    this.disabled = false;
                },
                (error) => {
                    console.error('Error de geolocalizaci√≥n:', error);
                    alert('No se pudo obtener la ubicaci√≥n. Verifique los permisos.');
                    this.innerHTML = 'üìç GPS';
                    this.disabled = false;
                }
            );
        } else {
            alert('Geolocalizaci√≥n no soportada en este dispositivo.');
        }
    });

    // Env√≠o del formulario
    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        // Mostrar estado de carga
        submitBtn.disabled = true;
        submitText.textContent = 'Guardando...';
        submitSpinner.style.display = 'inline-block';

        const formData = new FormData(form);

        try {
            if (navigator.onLine) {
                // Env√≠o normal
                const response = await fetch('/ageo/intData/', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // √âxito - redirigir
                    window.location.href = result.redirect_url || '/ageo/soliData/';
                } else {
                    // Error del servidor
                    throw new Error(result.error || 'Error del servidor');
                }
            } else {
                // Guardar offline
                await window.offlineManager.saveDataOffline(formData);

                // Mostrar modal de confirmaci√≥n
                const modal = new bootstrap.Modal(document.getElementById('offline-modal'));
                modal.show();

                // Limpiar formulario despu√©s de un delay
                setTimeout(() => {
                    form.reset();
                }, 2000);
            }
        } catch (error) {
            console.error('Error enviando formulario:', error);

            if (!navigator.onLine) {
                // Si no hay conexi√≥n, guardar offline
                await window.offlineManager.saveDataOffline(formData);
                const modal = new bootstrap.Modal(document.getElementById('offline-modal'));
                modal.show();
            } else {
                // Mostrar error
                alert('Error: ' + error.message);
            }
        } finally {
            // Restaurar estado del bot√≥n
            submitBtn.disabled = false;
            submitText.textContent = 'üíæ Guardar Datos';
            submitSpinner.style.display = 'none';
        }
    });

    // Validaci√≥n en tiempo real del CURP
    document.getElementById('curp').addEventListener('input', function(e) {
        const curp = e.target.value.toUpperCase();
        e.target.value = curp;

        if (curp.length === 18) {
            const pattern = /^[A-Z]{4}[0-9]{6}[HM][A-Z]{5}[0-1A-Z][0-9]$/;
            if (pattern.test(curp)) {
                e.target.classList.remove('is-invalid');
                e.target.classList.add('is-valid');
            } else {
                e.target.classList.remove('is-valid');
                e.target.classList.add('is-invalid');
            }
        } else {
            e.target.classList.remove('is-valid', 'is-invalid');
        }
    });
});
</script>
{% endblock %}