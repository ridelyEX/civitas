{% extends 'mobile/base.html' %}

{% block header_title %}Historial de Tr√°mites{% endblock %}

{% block content %}
<!-- Filtros y b√∫squeda -->
<div class="card">
    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <input type="text" id="searchInput" class="form-control" placeholder="üîç Buscar por nombre, CURP o folio..." style="flex: 1;">
        <button onclick="toggleFilters()" class="btn btn-secondary" style="min-width: 60px;">
            ‚öôÔ∏è
        </button>
    </div>

    <div id="filterPanel" style="display: none;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
            <select id="puoFilter" class="form-control">
                <option value="">Todos los PUO</option>
                <option value="OFI">Oficio</option>
                <option value="CRC">CRC</option>
                <option value="MEC">Marca el cambio</option>
                <option value="DLO">Diputado Local</option>
                <option value="DFE">Diputado Federal</option>
                <option value="REG">Regidores</option>
                <option value="DEA">Despacho del Alcalde</option>
                <option value="EVA">Evento con el Alcalde</option>
                <option value="PED">Presencial en Direcci√≥n</option>
                <option value="VIN">Vinculaci√≥n</option>
                <option value="PPA">Presupuesto participativo</option>
                <option value="CPC">Coordinaci√≥n de Participaci√≥n Ciudadana</option>
            </select>

            <input type="date" id="dateFilter" class="form-control">
        </div>

        <div style="display: flex; gap: 10px;">
            <button onclick="applyFilters()" class="btn btn-primary" style="flex: 1;">
                Aplicar Filtros
            </button>
            <button onclick="clearFilters()" class="btn btn-secondary" style="flex: 1;">
                Limpiar
            </button>
        </div>
    </div>
</div>

<!-- Estad√≠sticas r√°pidas -->
<div class="card">
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center;">
        <div style="padding: 10px; background: #e3f2fd; border-radius: 6px;">
            <div style="font-size: 18px; font-weight: bold; color: #1976d2;" id="totalCount">
                {{ solicitudes|length }}
            </div>
            <div style="font-size: 11px; color: #666;">Total</div>
        </div>
        <div style="padding: 10px; background: #e8f5e8; border-radius: 6px;">
            <div style="font-size: 18px; font-weight: bold; color: #2e7d32;" id="todayCount">0</div>
            <div style="font-size: 11px; color: #666;">Hoy</div>
        </div>
        <div style="padding: 10px; background: #fff3e0; border-radius: 6px;">
            <div style="font-size: 18px; font-weight: bold; color: #f57c00;" id="weekCount">0</div>
            <div style="font-size: 11px; color: #666;">Esta sem.</div>
        </div>
    </div>
</div>

<!-- Lista de tr√°mites -->
<div id="tramitesList">
    {% for solicitud in solicitudes %}
    <div class="tramite-item card" data-puo="{{ solicitud.puo }}" data-fecha="{{ solicitud.fecha|date:'Y-m-d' }}" data-search="{{ solicitud.data_ID.nombre|lower }} {{ solicitud.data_ID.pApe|lower }} {{ solicitud.data_ID.mApe|lower }} {{ solicitud.data_ID.curp|lower }} {{ solicitud.folio|lower }}">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
            <div style="flex: 1;">
                <div style="font-weight: 600; color: #333; margin-bottom: 4px;">
                    {{ solicitud.data_ID.nombre }} {{ solicitud.data_ID.pApe }} {{ solicitud.data_ID.mApe }}
                </div>
                <div style="font-size: 12px; color: #666; margin-bottom: 6px;">
                    üìÖ {{ solicitud.fecha|date:"d/m/Y H:i" }}
                </div>
            </div>
            <div style="text-align: right;">
                <span class="puo-badge" data-puo="{{ solicitud.puo }}">{{ solicitud.puo }}</span>
            </div>
        </div>

        <div style="margin-bottom: 10px;">
            <div style="font-size: 13px; color: #555; margin-bottom: 4px;">
                üìç {{ solicitud.dirr|truncatechars:50 }}
            </div>
            {% if solicitud.folio %}
            <div style="font-size: 12px; color: #007bff;">
                üìÑ Folio: {{ solicitud.folio }}
            </div>
            {% endif %}
        </div>

        {% if solicitud.descc %}
        <div style="font-size: 12px; color: #666; background: #f8f9fa; padding: 8px; border-radius: 4px; margin-bottom: 10px;">
            {{ solicitud.descc|truncatechars:100 }}
        </div>
        {% endif %}

        <div style="display: flex; justify-content: space-between; align-items: center;">
            <small style="color: #999;">
                üë§ {{ solicitud.data_ID.curp|slice:":4" }}***
            </small>
            <div style="display: flex; gap: 8px;">
                <button onclick="viewDetails({{ solicitud.id }})" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;">
                    üëÅÔ∏è Ver
                </button>
                {% if solicitud.foto %}
                <button onclick="viewPhoto({{ solicitud.id }})" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;">
                    üì∑ Foto
                </button>
                {% endif %}
            </div>
        </div>
    </div>
    {% empty %}
    <div class="card" style="text-align: center; padding: 40px 20px;">
        <div style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;">üìã</div>
        <h3 style="color: #666; margin-bottom: 10px;">No hay tr√°mites</h3>
        <p style="color: #999; margin-bottom: 20px;">A√∫n no has procesado ning√∫n tr√°mite.</p>
        <a href="{% url 'data' %}" class="btn btn-primary">
            Crear Primer Tr√°mite
        </a>
    </div>
    {% endfor %}
</div>

<!-- Paginaci√≥n m√≥vil -->
{% if solicitudes|length > page_size %}
<div class="card" style="text-align: center;">
    <button id="loadMoreBtn" onclick="loadMore()" class="btn btn-primary" style="width: 100%;">
        Cargar m√°s tr√°mites
    </button>
</div>
{% endif %}

<!-- Modal para detalles -->
<div id="detailModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; padding: 20px;">
    <div style="background: white; border-radius: 12px; max-height: 90vh; overflow-y: auto; position: relative;">
        <div style="padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
            <h3>Detalles del Tr√°mite</h3>
            <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        <div id="modalContent" style="padding: 20px;">
            <!-- Contenido din√°mico -->
        </div>
    </div>
</div>

<!-- Indicador de carga -->
<div id="loadingIndicator" class="loading" style="display: none;">
    <div class="spinner"></div>
    <div>Cargando tr√°mites...</div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .puo-badge {
        font-size: 10px;
        padding: 4px 8px;
        border-radius: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .puo-badge[data-puo="OFI"] { background: #e3f2fd; color: #1976d2; }
    .puo-badge[data-puo="CRC"] { background: #e8f5e8; color: #2e7d32; }
    .puo-badge[data-puo="MEC"] { background: #fff3e0; color: #f57c00; }
    .puo-badge[data-puo="DLO"] { background: #fce4ec; color: #c2185b; }
    .puo-badge[data-puo="DFE"] { background: #f3e5f5; color: #7b1fa2; }
    .puo-badge[data-puo="REG"] { background: #e0f2f1; color: #00695c; }
    .puo-badge[data-puo="DEA"] { background: #fff8e1; color: #ff8f00; }
    .puo-badge[data-puo="EVA"] { background: #efebe9; color: #5d4037; }
    .puo-badge[data-puo="PED"] { background: #e1f5fe; color: #0277bd; }
    .puo-badge[data-puo="VIN"] { background: #f1f8e9; color: #33691e; }
    .puo-badge[data-puo="PPA"] { background: #fff3e0; color: #e65100; }
    .puo-badge[data-puo="CPC"] { background: #f9fbe7; color: #827717; }

    .tramite-item {
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .tramite-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .tramite-item.hidden {
        display: none;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Variables globales
    let allTramites = [];
    let filteredTramites = [];
    let currentPage = 1;
    const itemsPerPage = {{ page_size }};

    // Cache de datos offline
    const tramitesData = {{ solicitudes_json|safe }};

    // Inicializar
    document.addEventListener('DOMContentLoaded', function() {
        initializeTramites();
        updateStats();

        // Configurar b√∫squeda en tiempo real
        document.getElementById('searchInput').addEventListener('input', debounce(handleSearch, 300));

        // Guardar datos offline
        if (navigator.onLine) {
            localStorage.setItem('desur_historial_cache', JSON.stringify({
                data: tramitesData,
                timestamp: Date.now(),
                expiry: Date.now() + (24 * 60 * 60 * 1000) // 24 horas
            }));
        }
    });

    function initializeTramites() {
        allTramites = Array.from(document.querySelectorAll('.tramite-item'));
        filteredTramites = [...allTramites];
    }

    function updateStats() {
        const today = new Date().toISOString().split('T')[0];
        const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

        const todayCount = allTramites.filter(item => {
            const itemDate = item.dataset.fecha;
            return itemDate === today;
        }).length;

        const weekCount = allTramites.filter(item => {
            const itemDate = item.dataset.fecha;
            return itemDate >= weekAgo;
        }).length;

        document.getElementById('todayCount').textContent = todayCount;
        document.getElementById('weekCount').textContent = weekCount;
    }

    function toggleFilters() {
        const panel = document.getElementById('filterPanel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }

    function handleSearch() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();

        filteredTramites = allTramites.filter(item => {
            const searchData = item.dataset.search;
            return searchData.includes(searchTerm);
        });

        updateDisplay();
    }

    function applyFilters() {
        const puoFilter = document.getElementById('puoFilter').value;
        const dateFilter = document.getElementById('dateFilter').value;
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();

        filteredTramites = allTramites.filter(item => {
            let matches = true;

            if (searchTerm && !item.dataset.search.includes(searchTerm)) {
                matches = false;
            }

            if (puoFilter && item.dataset.puo !== puoFilter) {
                matches = false;
            }

            if (dateFilter && item.dataset.fecha !== dateFilter) {
                matches = false;
            }

            return matches;
        });

        updateDisplay();
        document.getElementById('totalCount').textContent = filteredTramites.length;
    }

    function clearFilters() {
        document.getElementById('puoFilter').value = '';
        document.getElementById('dateFilter').value = '';
        document.getElementById('searchInput').value = '';

        filteredTramites = [...allTramites];
        updateDisplay();
        document.getElementById('totalCount').textContent = allTramites.length;
    }

    function updateDisplay() {
        // Ocultar todos los elementos
        allTramites.forEach(item => {
            item.classList.add('hidden');
        });

        // Mostrar elementos filtrados
        filteredTramites.forEach(item => {
            item.classList.remove('hidden');
        });

        // Actualizar contador
        document.getElementById('totalCount').textContent = filteredTramites.length;
    }

    function viewDetails(tramiteId) {
        const modal = document.getElementById('detailModal');
        const content = document.getElementById('modalContent');

        // Buscar datos del tr√°mite
        const tramiteData = tramitesData.find(t => t.id === tramiteId);

        if (tramiteData) {
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h4>${tramiteData.tramite || 'Tr√°mite'}</h4>
                    <p><strong>ID:</strong> ${tramiteData.id}</p>
                    <p><strong>Fecha:</strong> ${new Date(tramiteData.fecha).toLocaleString()}</p>
                    <p><strong>Estado:</strong> ${tramiteData.estado || 'En proceso'}</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h5>Observaciones:</h5>
                    <p style="background: #f8f9fa; padding: 10px; border-radius: 6px;">
                        ${tramiteData.observaciones || 'Sin observaciones'}
                    </p>
                </div>

                <div style="text-align: center;">
                    <button onclick="closeModal()" class="btn btn-primary">Cerrar</button>
                </div>
            `;
        } else {
            content.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <p>No se pudieron cargar los detalles del tr√°mite.</p>
                    <button onclick="closeModal()" class="btn btn-primary">Cerrar</button>
                </div>
            `;
        }

        modal.style.display = 'block';
    }

    function viewPhoto(tramiteId) {
        alert('Funci√≥n de visualizaci√≥n de fotos en desarrollo');
    }

    function closeModal() {
        document.getElementById('detailModal').style.display = 'none';
    }

    function loadMore() {
        // Implementar carga incremental si hay muchos datos
        alert('Funci√≥n de carga incremental en desarrollo');
    }

    // Funci√≥n de debounce para optimizar b√∫squeda
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Funcionalidad offline espec√≠fica
    if (!navigator.onLine) {
        // Cargar datos desde cache offline
        const cachedData = localStorage.getItem('desur_historial_cache');
        if (cachedData) {
            const cache = JSON.parse(cachedData);
            if (cache.expiry > Date.now()) {
                console.log('Usando datos de historial desde cache offline');
            }
        }
    }

    // Cerrar modal al hacer clic fuera
    document.getElementById('detailModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
</script>
{% endblock %}
