{% extends 'base.html' %} {% load static %} {% block head %}
 <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
    crossorigin="anonymous"
  />
<link rel="stylesheet" href="{% static 'styles/form.css' %}?v=1" />
<title>Obras Públicas</title>
{% endblock %} {% block body %} {% include 'nav.html' %}
<form method="post" enctype="multipart/form-data" id="mainForm" action="{% url 'soli' %}">
  {% csrf_token %}
<input type="hidden" name="uuid" value="{{ data.uuid }}">

  <div class="main" id="main">
    <div class="titulo"><h1>Datos de la solicitud</h1></div>
    <input type="hidden" name="asunto" value="{{ asunto }}" />
    <div class="left">
      <div class="form">
        <label for="dir" class="text">Dirección del servicio:</label>
        <input
          type="text"
          id="dir"
          class="input"
          name="dir"
          placeholder="Dirección del servicio: calle, colonia, número ex., C.P."
          value="{{dir}}"
        />
        <br />
        <div class="plus">
          <button
            type="button"
            class="addbtn"
            id="ubi"
            onclick="modals('open', 'modal')"
          >
            <span class="addicon">
              <img src="{% static 'images/addw.png' %}" alt="add" class="add" />
            </span>
            <span class="txt">Añadir ubicación</span>
          </button>
        </div>
        <br />

        <label for="desc" class="text">Descripción del servicio:</label>
        <br />
        <textarea
          class="tArea1"
          id="desc"
          name="descc"
          placeholder="Descripción del servicio"
        ></textarea>
        <br />
      </div>
    </div>

    <div class="right">
      <div class="form">
        <div class="ngrid">
          <div class="plus">
            <button type="button" class="addbtn" id="docs" onclick="modals('open', 'modalD')">
              <span class="addicon">
                <img src="{% static 'images/addw.png' %}" alt="add" class="add" />
              </span>
              <span class="txt">Documentación</span>
            </button>
          </div>

          <div class="checkbox-wrapper-46">
            <input type="checkbox" name="check" id="cbx-46" class="inp-cbx" />
            <label for="cbx-46" class="cbx">
              <span>
                <svg viewBox="0 0 12 10" height="10px" width="12px">
                  <polyline points="1.5 6 4.5 9 10.5 1"></polyline>
                </svg>
              </span>
              <div class="p1">Declaración bajo protesta
              </div>
            </label>
            <div>
            <span class="p2">
              Manifiesto bajo protesta de decir verdad que la información
              proporcionada en esta solicitud es verdadera,
              y que si me condujera con falsedad incurriría en una conducta
              tipificada en la Ley Penal de la cual seré acreedor a una medida de conformidad
              con las disposiciones aplicables en la materia.
            </span>
          </div>
          </div>

          <div class="nPuesto">
            <label for="puo" class="text">Origen de gestión</label>
            <select class="select" name="puo" id="puo">
              <option value="">Origen de gestión</option>
              <option value="Oficio">Oficio</option>
              <option value="CRC">CRC</option>
              <option value="Marca el cambio">Marca el cambio</option>
              <option value="Diputado local">Diputado local</option>
              <option value="Diputado federal">Diputado federal</option>
              <option value="Regidores">Regidores</option>
              <option value="Despacho del alcalde">Despacho del alcalde</option>
              <option value="Evento con el alcalde">Evento con el alcalde</option>
              <option value="Presencial en dirección">Presencial en dirección</option>
              <option value="Vinculación">Vinculación</option>
            </select>
          </div>

            <input type="file" id="file" name="file" accept="image/*">
          <div class="nFoto">
            <label for="search" class="text">Añadir foto</label>
            <button
              type="button"
              class="search sbtn"
              id="search"
              name="foto"
              >
              <span class="addicon">
              <img src="{% static 'images/photo.png' %}" alt="add" class="add" />
              </span>
              <span>Examinar</span>
            </button>
          </div>

        </div>
        <label for="info" class="text">Información adicional:</label>
        <br />
        <textarea
          class="tArea"
          id="info"
          name="info"
          placeholder="Información adicional"
        ></textarea>
        <br/>
      </div>
    </div>
  </div>

  <div class="bottom">
    <div class="lBtn">
      <button
        type="button"
        class="back bbtn"
        id="back"
        data-url="{% url 'data' %}"
        >
          Regresar
      </button>
    </div>

    <div class="rBtn">
      <button type="submit" class="next nbtn" id="next" name="action" value="save">Siguiente</button>
    </div>

    <div class="cBtn">
      <button
        type="button"
        class="cancel cbtn"
        id="cancel"
        onclick="document.querySelector('.popup').classList.add('active');"
      >
        Cancelar
      </button>
      <div class="popup">{% include 'adv.html' %}</div>
    </div>
  </div>
</form>
<div class="modal hidden" id="modal">
  {% include 'modals/modal_map.html' %}
</div>

<div class="modal hidden" id="modalD">
  {% include 'modals/modal_docs.html' %}
</div>

{% endblock %} {% block footer %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_key }}&libraries=places&callback=initMap" async defer></script>


<script>
  let map;
  let marker;

  function initMap() {
    const ubicacion = { lat: 28.6353, lng: -106.0889 };
    map = new google.maps.Map(document.getElementById("map"), {
      center: ubicacion,
      zoom: 15,
    });

    const geocoder = new google.maps.Geocoder();

    map.addListener("click", (e) => {
      const latLng = e.latLng;

      if (marker) {
        marker.setPosition(latLng);
      } else {
        marker = new google.maps.Marker({
          position: latLng,
          map: map,
        });
      }

      geocoder.geocode({ location: latLng }, (results, status) => {
        if (status === "OK" && results[0]) {
          document.getElementById("dirr").value = results[0].formatted_address;
        } else {
          console.error("No se pudo obtener la dirección: " + status);
        }
      });
    });
  }

  document.getElementById("mNext").addEventListener("click", function () {
    const dirInput = document.getElementById("dirr").value;
    if (!dirInput.trim()) {
      alert("Por favor selecciona una dirección en el mapa.");
      return;
    }
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const mainForm = document.querySelector('form[method="post"]');
    const formAction = mainForm.getAttribute('action');

    mainForm.addEventListener('submit', function(e) {
      e.preventDefault();

      const formData = new FormData(this);
      const tempDocs = JSON.parse(sessionStorage.getItem('tempDocs') || '[]');

      //agregar los documentos
      tempDocs.forEach((doc, index) => {
        const file = new File([doc.file], doc.name);
        formData.append(`tempfile_${index}`, file);
        formData.append(`tempdesc_${index}`, doc.desc);
      });

      fetch(formAction, {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
      })
      .then(response => {
        if (response.ok) {
          sessionStorage.removeItem('tempDocs');
          window.location.href = response.url;
        }
      })
      .catch(error => console.error('Error:', error));


    });
  });
</script>

<script src="{% static 'sripts/modals.js' %}"></script>

{% endblock %}
