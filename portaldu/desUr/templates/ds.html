{% extends 'base.html' %}
{% load static %}
{% block head %}
{% load django_bootstrap5 %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="{% static 'styles/form-cards.css' %}?v=1" />
<link rel="stylesheet" href="{% static 'styles/adv.css' %}?v=1" />
<link rel="stylesheet" href="{% static 'styles/camaraStyle.css' %}?v=2">
<title>Obras P√∫blicas</title>
{% endblock %}

{% block body %}
{% include 'nav.html' %}

<form method="post" enctype="multipart/form-data" id="mainForm" action="{% url 'soli' %}">
  {% csrf_token %}
  <input type="hidden" name="uuid" value="{{ data.uuid }}">
  <input type="hidden" name="asunto" value="{{ asunto }}" />

  <div class="form-container">
    <!-- T√çTULO PRINCIPAL -->
    <div class="main-title">
      <h1>DATOS DE LA SOLICITUD: {{ asunto_desc }}</h1>
    </div>

    <!-- TARJETA 1: UBICACI√ìN Y DIRECCI√ìN -->
    <div class="form-card">
      <div class="card-header">
        <h2>üìç Ubicaci√≥n del Servicio</h2>
      </div>
      <div class="card-content">
        <div class="form-group">
          <label for="dir" class="form-label">DIRECCI√ìN DEL SERVICIO:</label>
          <input
            type="text"
            id="dir"
            class="form-input"
            name="dir"
            placeholder="Direcci√≥n del servicio: calle, colonia, n√∫mero ext., C.P."
            value="{{ dir }}"
            required
            oninvalid="this.setCustomValidity('Ingrese la direcci√≥n del servicio')"
            oninput="this.setCustomValidity('')"
          />
        </div>

        <div class="form-group">
          <div class="plus">
          <button
                  type="button"
                  class="addbtn"
                  id="ubi"
                  data-bs-toggle="modal"
                  data-bs-target="#buscarDireccionModal"
          >
                  <!--onclick="openm()"-->
                  <span class="addicon">
                    <img src="{% static 'images/addw.png' %}" alt="add" class="add" />
                  </span>
            <span class="txt">A√±adir direcci√≥n</span>
          </button>
        </div>
        </div>

        <div class="form-group">
          <label for="info" class="form-label">REFERENCIAS DE LA UBICACI√ìN:</label>
          <textarea
            class="form-textarea"
            id="info"
            name="info"
            placeholder="Entre qu√© calles se encuentra el servicio, puntos de referencia, etc."
            required
          ></textarea>
        </div>
      </div>
    </div>

    <!-- TARJETA 2: DESCRIPCI√ìN DEL SERVICIO -->
    <div class="form-card">
      <div class="card-header">
        <h2>üìù Descripci√≥n del Servicio</h2>
      </div>
      <div class="card-content">
        <div class="form-group">
          <label for="desc" class="form-label">DESCRIPCI√ìN DETALLADA:</label>
          <textarea
            class="form-textarea large"
            id="desc"
            name="descc"
            placeholder="Describe detalladamente el servicio que necesitas..."
          ></textarea>
        </div>
      </div>
    </div>

    <!-- TARJETA 3: ORIGEN Y DOCUMENTACI√ìN -->
    <div class="form-card">
      <div class="card-header">
        <h2>üìã Informaci√≥n Administrativa</h2>
      </div>
      <div class="card-content">
        <div class="form-row">
          <div class="form-group">
            <label for="puo" class="form-label">ORIGEN DE SOLICITUD:</label>
            <select
              class="form-select"
              name="puo"
              id="puo"
              required
              oninvalid="this.setCustomValidity('Seleccione el origen de gesti√≥n')"
              oninput="this.setCustomValidity('')"
            >
              <option value="">Seleccionar origen de gesti√≥n</option>
              <option value="OFI">Oficio</option>
              <option value="CRC">CRC</option>
              <option value="MEC">Marca el cambio</option>
              <option value="DLO">Diputado local</option>
              <option value="DFE">Diputado federal</option>
              <option value="REG">Regidores</option>
              <option value="DEA">Despacho del alcalde</option>
              <option value="EVA">Evento con el alcalde</option>
              <option value="PED">Presencial en direcci√≥n</option>
              <option value="VIN">Vinculaci√≥n</option>
              <option value="PPA">Presupuesto participativo</option>
              <option value="CPC">Coordinaci√≥n de Participaci√≥n Ciudadana</option>
            </select>
          </div>

          <div class="form-group">
            <label for="ofi" class="form-label">N√öMERO DE OFICIO:</label>
            <input
              type="text"
              id="ofi"
              class="form-input"
              name="ofi"
              placeholder="N√∫mero de oficio (si aplica)"
            />
          </div>
        </div>

        <div class="form-group">
          <button
            type="button"
            class="action-btn docs-btn"
            id="docs"
            onclick="modals('open', 'modalD')"
          >
            <span class="btn-icon">
              <img src="{% static 'images/addw.png' %}" alt="add" />
            </span>
            <span class="btn-text">Agregar documentaci√≥n</span>
          </button>
        </div>
      </div>
    </div>

    <!-- TARJETA 4: EVIDENCIA FOTOGR√ÅFICA -->
    <div class="form-card">
      <div class="card-header">
        <h2>üì∑ Evidencia Fotogr√°fica</h2>
      </div>
      <div class="card-content">
        <div class="photo-section">
          <div class="photo-example">
            <p class="example-label">EJEMPLO DE FOTO:</p>
            <img src="{% static 'images/EjemploFoto.png' %}" alt="mono" class="example-image">
          </div>

          <div class="photo-upload">
            <label for="searchPhoto" class="form-label">TOMAR FOTO CON IDENTIFICACI√ìN:</label>
            <button
              type="button"
              class="action-btn photo-btn"
              id="searchPhoto"
              name="foto"
              {% if not is_mobile and not is_tablet %}
              onclick="modals('open', 'camaraD')"
              {% endif %}
            >
              <span class="btn-icon">
                <img src="{% static 'images/photo.png' %}" alt="c√°mara" />
              </span>
              <span class="btn-text">Tomar foto con identificaci√≥n</span>
            </button>
            {% if is_mobile or is_tablet %}
            <input type="file" accept="image/*" capture="camera" name="src" id="cameraInput" style="display:none;" hidden required>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- TARJETA 5: DECLARACI√ìN -->
    <div class="form-card declaration-card">
      <div class="card-header">
        <h2>‚öñÔ∏è Declaraci√≥n Bajo Protesta</h2>
      </div>
      <div class="card-content">
        <div class="checkbox-wrapper-46">
          <input type="checkbox" name="check" id="cbx-46" class="inp-cbx" required />
          <label for="cbx-46" class="cbx">
            <span>
              <svg viewBox="0 0 12 10" height="10px" width="12px">
                <polyline points="1.5 6 4.5 9 10.5 1"></polyline>
              </svg>
            </span>
            <div class="declaration-text">
              <div class="declaration-title">Acepto la declaraci√≥n bajo protesta</div>
            </div>
          </label>
          <div class="declaration-details">
            <p>
              Manifiesto bajo protesta de decir verdad que la informaci√≥n
              proporcionada en esta solicitud es verdadera,
              y que si me condujera con falsedad incurrir√≠a en una conducta
              tipificada en la Ley Penal de la cual ser√© acreedor a una medida de conformidad
              con las disposiciones aplicables en la materia.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- BOTONES DE NAVEGACI√ìN -->
    <div class="form-actions">
      <div class="actions-row">
        <button
          type="button"
          class="nav-btn back-btn"
          id="back"
          data-url="{% url 'data' %}"
        >
          ‚Üê Regresar
        </button>

        <button
          type="submit"
          class="nav-btn next-btn"
          id="next"
          name="action"
          value="save"
        >
          Siguiente ‚Üí
        </button>
      </div>

      <div class="cancel-action">
        <button
          type="button"
          class="nav-btn cancel-btn"
          id="cancel"
          onclick="document.querySelector('.popup').classList.add('active');"
        >
          Cancelar
        </button>
      </div>
    </div>
  </div>

  <!-- Popup de cancelaci√≥n -->
</form>

<div class="popup">
    <div class="popup-overlay"></div>
        {% include 'adv.html' %}
</div>

<!-- Modales -->
<div class="modal hidden" id="camaraD">
  {% include 'modals/camaraS.html' %}
</div>

{% include 'modals/buscar_direccion.html' %}


<div class="modal hidden" id="modalD">
  {% include 'modals/modal_docs.html' %}
</div>

{% endblock %}

{% block footer %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar modal manualmente
    const modalElement = document.getElementById('buscarDireccionModal');
    if (modalElement) {
        const modal = new bootstrap.Modal(modalElement);

        // Evento para el bot√≥n que abre el modal
        document.querySelectorAll('[data-bs-target="#buscarDireccionModal"]').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                modal.show();
            });
        });
    }
});


</script>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/esri-leaflet@3.0.8/dist/esri-leaflet.js"></script>
<script src="{% static 'sripts/LocalGisMap.js' %}"></script>

<script>

function initializeMap() {
    const mapHolder = document.querySelector('.mapholder');

    if (!window.localMap && mapHolder) {
        let attempts = 0;
        const maxAttempts = 10;

        const checkAndInit = () => {
            if (typeof LocalGISMap !== 'undefined') {
                console.log('üó∫Ô∏è LocalGISMap encontrado, creando mapa...');

                const mapDiv = document.createElement('div');
                mapDiv.id = 'map';
                mapDiv.style.cssText = 'width: 100%; height: 25rem; border: 2px solid #014277; background-color: lightgrey; cursor: crosshair;';

                const instructions = document.createElement('div');
                instructions.innerHTML = `
                    <div style="background: #e3f2fd; border: 1px solid #2196f3; padding: 8px; border-radius: 4px; margin-bottom: 8px; font-size: 12px;">
                        <strong>üí° Instrucciones:</strong><br>
                        ‚Ä¢ <strong>Buscar:</strong> Escribe una direcci√≥n y presiona "Buscar"<br>
                        ‚Ä¢ <strong>Hacer clic:</strong> Haz clic en cualquier punto del mapa<br>
                        ‚Ä¢ <strong>Seleccionar:</strong> Usa el bot√≥n "Seleccionar" en el popup
                    </div>
                `;

                mapHolder.innerHTML = '';
                mapHolder.appendChild(instructions);
                mapHolder.appendChild(mapDiv);

                setTimeout(() => {
                    try {
                        window.localMap = new LocalGISMap('map', {
                            center: [28.6353, -106.0889],
                            zoom: 12
                        });
                        console.log('‚úÖ Mapa inicializado correctamente');
                    } catch (error) {
                        console.error('‚ùå Error inicializando mapa:', error);
                        mapDiv.innerHTML = `<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">Error cargando el mapa: ${error.message}</div>`;
                    }
                }, 200);
            } else {
                attempts++;
                if (attempts < maxAttempts) {
                    console.log(`‚è≥ Esperando LocalGISMap... intento ${attempts}/${maxAttempts}`);
                    setTimeout(checkAndInit, 300);
                } else {
                    console.error('‚ùå LocalGISMap no se carg√≥ despu√©s de m√∫ltiples intentos');
                    if (mapHolder) {
                        mapHolder.innerHTML = '<div style="color: red; padding: 20px; text-align: center;">‚ùå Error: No se pudo cargar el componente del mapa<br><small>Verifica tu conexi√≥n a internet</small></div>';
                    }
                }
            }
        };

        checkAndInit();
    } else if (window.localMap) {
        console.log('‚ÑπÔ∏è El mapa ya est√° inicializado');
    } else {
        console.warn('‚ö†Ô∏è No se encontr√≥ el contenedor .mapholder');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    let localMap = null;

    // Funci√≥n global para seleccionar ubicaci√≥n desde el mapa
    window.selectMapLocation = function(address, lat, lng, components = {}) {
        // Actualizar input principal del formulario
        const mainInput = document.getElementById('dir');
        if (mainInput) {
            mainInput.value = address;
        }

        // Actualizar input del modal
        const modalInput = document.getElementById('dirr');
        if (modalInput) {
            modalInput.value = address;
        }

        // Actualizar inputs espec√≠ficos con componentes
        if (components && typeof components === 'object') {
            const fieldMappings = {
                'calle': components.calle || '',
                'numero': components.numero || '',
                'colonia': components.colonia || '',
                'codigo_postal': components.codigo_postal || '',
                'ciudad': components.ciudad || 'Chihuahua',
                'estado': components.estado || 'Chihuahua'
            };

            for (const [fieldName, value] of Object.entries(fieldMappings)) {
                const field = document.getElementById(fieldName);
                if (field && value) {
                    field.value = value;
                    console.log(`Campo ${fieldName} actualizado con: ${value}`);
                }
            }
        }

        // Mostrar confirmaci√≥n con detalles
        const confirmMsg = document.createElement('div');
        let detailsHtml = '';

        if (components && typeof components === 'object') {
            const details = [];
            if (components.calle) details.push(`Calle: ${components.calle}`);
            if (components.numero) details.push(`N√∫m: ${components.numero}`);
            if (components.colonia) details.push(`Col: ${components.colonia}`);
            if (components.codigo_postal) details.push(`CP: ${components.codigo_postal}`);

            if (details.length > 0) {
                detailsHtml = `<small style="display:block; margin-top:4px; opacity:0.9;">${details.join(' | ')}</small>`;
            }
        }

        confirmMsg.innerHTML = `
            ‚úÖ <strong>Direcci√≥n seleccionada</strong><br>
            ${address}
            ${detailsHtml}
        `;
        confirmMsg.style.cssText = `
            position: fixed; top: 20px; right: 20px;
            background: #4CAF50; color: white;
            padding: 12px 16px; border-radius: 6px;
            z-index: 10000; max-width: 300px;
            font-size: 13px; box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        `;

        document.body.appendChild(confirmMsg);
        setTimeout(() => confirmMsg.remove(), 4000);

        console.log('Direcci√≥n seleccionada:', {
            address, lat, lng, components
        });
    };

    // Funci√≥n global SEPARADA para manejar la selecci√≥n desde popup
    window.selectMapLocationFromPopup = function(address, lat, lng, componentsStr) {
        try {
            console.log('Datos recibidos en popup:', { address, lat, lng, componentsStr });

            // Parsear componentes
            let components = {};
            if (componentsStr && componentsStr !== '{}') {
                // Decodificar caracteres HTML
                const decodedStr = componentsStr.replace(/&#39;/g, "'").replace(/&quot;/g, '"');
                components = JSON.parse(decodedStr);
                console.log('Componentes parseados:', components);
            }

            // Llamar a la funci√≥n principal
            window.selectMapLocation(address, lat, lng, components);

        } catch (error) {
            console.error('Error procesando selecci√≥n desde popup:', error);
            console.log('Usando fallback sin componentes');
            // Fallback sin componentes
            window.selectMapLocation(address, lat, lng, {});
        }
    };

    // Funci√≥n para b√∫squeda manual
    window.buscarDireccion = async function() {
        const inputModal = document.getElementById('dirr');
        let address = inputModal.value.trim();

        if (!address) {
            alert('Por favor ingresa una direcci√≥n para buscar');
            return;
        }

        address = address.replace(/\s+/g, ' ');
        address = address.replace(/[^\w\s√°√©√≠√≥√∫√±√º#.,]/gi, ' ');

        if (address.length < 3) {
            alert('La b√∫squeda debe tener al menos 3 caracteres');
            return;
        }

        if (localMap) {
            const originalValue = inputModal.value;
            const originalPlaceholder = inputModal.placeholder;

            inputModal.value = 'Buscando direcci√≥n...';
            inputModal.disabled = true;

            try {
                console.log(`üîç Buscando: "${address}"`);

                const result = await localMap.geocodeAddress(address);

                if (result && result.success) {
                    console.log('‚úÖ B√∫squeda exitosa:', result.result);
                    // El popup ya se encarga de mostrar el resultado
                } else {
                    console.log('‚ùå No se encontr√≥:', result.error);
                    alert(`No se encontr√≥ la direcci√≥n: ${address}\n\nIntenta con:\n‚Ä¢ Formato: "Calle Nombre #123"\n‚Ä¢ Agregar colonia o c√≥digo postal`);
                }

                inputModal.value = originalValue;
                inputModal.disabled = false;

            } catch (error) {
                console.error('Error en b√∫squeda:', error);

                const errorMsg = document.createElement('div');
                errorMsg.innerHTML = `‚ùå <strong>Error de conexi√≥n</strong><br><small>Verifica tu internet e intenta nuevamente</small>`;
                errorMsg.style.cssText = `
                    position: fixed; top: 20px; right: 20px;
                    background: #f44336; color: white;
                    padding: 12px; border-radius: 6px;
                    z-index: 10000; max-width: 300px;
                    font-size: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                `;
                document.body.appendChild(errorMsg);
                setTimeout(() => errorMsg.remove(), 4000);

                inputModal.value = originalValue;
                inputModal.disabled = false;
            }

            inputModal.placeholder = originalPlaceholder;
        }
    };

    // Resto de funciones para modal...
    window.openm = function() {
        console.log('üîÑ Abriendo modal de mapa...');
        const modal = document.getElementById('modal');
        modal.classList.remove('hidden');
        modal.style.display = 'block';

        const inputModal = document.getElementById('dirr');
        if (inputModal) {
            inputModal.value = '';
            setTimeout(() => inputModal.focus(), 300);
        }

        // Inicializar mapa inmediatamente
        setTimeout(() => {
            initializeMap();
        }, 100);
    };

    window.closem = function() {
        const modal = document.getElementById('modal');
        modal.classList.add('hidden');
        modal.style.display = 'none';
    };

    window.enviar = function() {
        const direccionModal = document.getElementById('dirr').value.trim();
        if (direccionModal) {
            document.getElementById('dir').value = direccionModal;

            const confirmMsg = document.createElement('div');
            confirmMsg.innerHTML = `‚úÖ Direcci√≥n guardada: ${direccionModal}`;
            confirmMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4CAF50; color: white; padding: 10px; border-radius: 5px; z-index: 10000;';
            document.body.appendChild(confirmMsg);

            setTimeout(() => confirmMsg.remove(), 3000);
        }
        closem();
    };

    window.onclick = function(event) {
        const modal = document.getElementById('modal');
        if (event.target === modal) {
            closem();
        }
    };
});

// Funci√≥n para habilitar campos condicionales
function habilitar(estado) {
    document.getElementById("etnia").disabled = !estado;
}

function habilitarD(estado) {
    document.getElementById("disc").disabled = !estado;
}

function habilitarV(estado) {
    document.getElementById("vulnerables").disabled = !estado;
}
</script>

<script src="{% static 'sripts/modals.js' %}"></script>
<script src="{% static 'sripts/btnScripts.js' %}"></script>

{% if is_mobile or is_tablet %}
<script src="{% static 'sripts/mPhoto.js' %}"></script>
{% else %}
<script src="{% static 'sripts/fotos.js' %}"></script>
{% endif %}
{% endblock %}